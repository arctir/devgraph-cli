name: Release Go CLI with GoReleaser

# Workflow-wide environment variables
env:
  CLI_NAME: "devgraph" # Your CLI's name, used in .goreleaser.yaml

on:
  push:
    tags:
      - "v*" # Trigger on version tags like v1.0.0

permissions:
  contents: write # Required to upload assets to the release

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.24" # Match your project's Go version
          cache: true

      - name: Configure Git for private modules
        env:
          GITHUB_TOKEN: ${{ secrets.ARCTIR_GH_ACTIONS_TOKEN }}
        run: git config --global url."https://x-oauth-basic:${GITHUB_TOKEN}@github.com".insteadOf "https://github.com"
        
      - name: Install dependencies
        run: go mod download
        env:
          GOPRIVATE: github.com/arctir/*

      - name: Run tests
        run: make test

      - name: Run linter
        run: make lint

  goreleaser:
    needs: test  # Only run if tests pass
    runs-on: ubuntu-latest
    steps:
      # Checkout the repository with full history
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Needed for changelog generation

      # Set up Go environment
      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.24" # Match your project's Go version  
          cache: true # Cache Go modules for faster builds

      - name: Configure Git for private modules
        env:
          GITHUB_TOKEN: ${{ secrets.ARCTIR_GH_ACTIONS_TOKEN }}
        run: git config --global url."https://x-oauth-basic:${GITHUB_TOKEN}@github.com".insteadOf "https://github.com"

      # Run GoReleaser to build and release
      - name: Run GoReleaser
        uses: goreleaser/goreleaser-action@v6
        with:
          distribution: goreleaser # Use 'goreleaser-pro' for pro features
          version: "~> v2" # Pin to v2.x, or use 'latest'
          args: release --clean # Build and publish, clean build dir after
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }} # Auth for GitHub Releases
          GOPRIVATE: github.com/arctir/*

      # Optional: Print release URL (for debugging or logs)
      - name: Print Release URL
        run: echo "Release published at ${{ github.event.release.html_url }}"
